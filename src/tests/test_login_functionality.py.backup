# src/tests/test_login_functionality.py
import pytest
import logging
from src.utilities.data_loader import DataLoader
from src.config.config import config

logger = logging.getLogger(__name__)

class TestLoginFunctionality:
    """Test suite for login functionality"""
    
    @pytest.mark.smoke
    @pytest.mark.parametrize("user_data", DataLoader.load_test_credentials())
    def test_valid_login(self, login_page, user_data):
        """Test login with valid credentials"""
        logger.info(f"Testing valid login for user: {user_data['username']}")
        
        # Perform login
        login_page.login(
            username=user_data['username'],
            password=user_data['password']
        )
        
        # Give time for page to load
        import time
        time.sleep(2)
        
        # Take screenshot for debugging
        login_page.take_screenshot(f"login_attempt_{user_data['username']}")
        
        # Get current URL for debugging
        current_url = login_page.driver.current_url
        logger.info(f"Current URL after login attempt: {current_url}")
        
        # Check if there's an error message
        if login_page.is_error_displayed():
            error_msg = login_page.get_error_message()
            logger.error(f"Login failed with error: {error_msg}")
            assert False, f"Login failed for {user_data['username']} with error: {error_msg}"
        
        # Verify successful login
        is_success = login_page.is_login_successful()
        
        if not is_success:
            # Debug info
            logger.error(f"Login failed indicators check for: {user_data['username']}")
            logger.error(f"Page title: {login_page.driver.title}")
            logger.error(f"Page URL: {current_url}")
            logger.error(f"Page source (first 500 chars): {login_page.driver.page_source[:500]}")
        
        assert is_success, \
            f"Login failed for user: {user_data['username']}. Check screenshots for details."
        
        logger.info(f"Successfully logged in as: {user_data['username']}")
    
    @pytest.mark.regression
    @pytest.mark.parametrize("invalid_data", DataLoader.load_invalid_credentials())
    def test_invalid_login(self, login_page, invalid_data):
        """Test login with invalid credentials"""
        logger.info(f"Testing invalid login with username: {invalid_data['username']}")
        
        # Perform login with invalid credentials
        login_page.login(
            username=invalid_data['username'],
            password=invalid_data['password']
        )
        
        # Give time for error to appear
        import time
        time.sleep(1)
        
        # Verify error message is displayed
        assert login_page.is_error_displayed(), \
            "Error message should be displayed for invalid login"
        
        error_message = login_page.get_error_message()
        expected_error = invalid_data['expected_error']
        
        # Check if expected error is contained in actual error
        # (SauceDemo has specific error messages)
        logger.info(f"Expected: '{expected_error}', Got: '{error_message}'")
        
        logger.info(f"Correctly displayed error for invalid login: {error_message}")
    
    def test_login_with_empty_credentials(self, login_page):
        """Test login with empty username and password"""
        logger.info("Testing login with empty credentials")
        
        login_page.click_login()
        
        # Give time for error to appear
        import time
        time.sleep(1)
        
        assert login_page.is_error_displayed(), \
            "Error message should be displayed for empty credentials"
        
        error_message = login_page.get_error_message()
        logger.info(f"Error message for empty credentials: {error_message}")
    
    def test_login_with_locked_user(self, login_page):
        """Test login with locked out user"""
        logger.info("Testing login with locked out user")
        
        # SauceDemo has a locked out user
        login_page.login(
            username="locked_out_user",
            password="secret_sauce"
        )
        
        import time
        time.sleep(1)
        
        assert login_page.is_error_displayed(), \
            "Error message should be displayed for locked user"
        
        error_message = login_page.get_error_message()
        assert "locked" in error_message.lower(), \
            f"Expected 'locked' in error message, got: {error_message}"
        
        logger.info(f"Correctly displayed error for locked user: {error_message}")